<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Exportar Viaje como KML</title>

  <!-- LibrerÃ­as -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/tokml/tokml.js"></script>
</head>
<body>
  <div id="exportKML" style="font-family:'Segoe UI',Roboto,Arial,sans-serif; color:#333; background:transparent; display:flex; justify-content:center; align-items:flex-start; padding:20px;">
    <div style="background:#fff; padding:30px 40px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.1); width:100%; max-width:500px;">
      <h2 style="text-align:center; color:#1a73e8; margin-bottom:25px; font-weight:600;">Exportar viaje a KML</h2>

      <label style="display:block; margin-top:15px; font-weight:500;">Dispositivo:</label>
      <select id="deviceSelect" style="width:100%; padding:10px; margin-top:6px; border:1px solid #d0d7de; border-radius:8px; font-size:15px;"></select>

      <label style="display:block; margin-top:15px; font-weight:500;">Fecha inicio:</label>
      <input type="datetime-local" id="fromDate" style="width:100%; padding:10px; margin-top:6px; border:1px solid #d0d7de; border-radius:8px; font-size:15px;">

      <label style="display:block; margin-top:15px; font-weight:500;">Fecha fin:</label>
      <input type="datetime-local" id="toDate" style="width:100%; padding:10px; margin-top:6px; border:1px solid #d0d7de; border-radius:8px; font-size:15px;">

      <label style="display:block; margin-top:15px; font-weight:500;">Nombre de archivo:</label>
      <input type="text" id="filename" value="Viaje_a_KML" style="width:100%; padding:10px; margin-top:6px; border:1px solid #d0d7de; border-radius:8px; font-size:15px;">

      <button id="generate" style="width:100%; margin-top:25px; background:#1a73e8; color:white; padding:12px; border:none; border-radius:8px; font-size:16px; cursor:pointer;">Generar KML</button>

      <pre id="log" style="margin-top:25px; background:#f9fafc; border:1px solid #e0e0e0; border-radius:10px; padding:15px; font-family:'Courier New',monospace; font-size:13px; color:#333; white-space:pre-wrap; max-height:250px; overflow-y:auto; line-height:1.5;"></pre>
    </div>
  </div>

  <script>
    (function() {
      var api = null;
      var state = null;
      var logBox = document.getElementById('log');

      function log(msg) {
        logBox.textContent += msg + '\n';
        logBox.scrollTop = logBox.scrollHeight;
      }

      function loadDevices() {
        log('ðŸ“¡ Cargando dispositivos...');
        api.call("Get", { typeName: "Device" }, function(result) {
          var select = document.getElementById("deviceSelect");
          select.innerHTML = "";
          for (var i = 0; i < result.length; i++) {
            var opt = document.createElement("option");
            opt.value = result[i].id;
            opt.textContent = result[i].name;
            select.appendChild(opt);
          }
          log("âœ… Dispositivos cargados: " + result.length);
        }, function(err) {
          log("âŒ Error al cargar dispositivos: " + err);
        });
      }

      function getLogRecords(deviceId, fromDate, toDate, callback) {
        log("â³ Obteniendo registros...");
        api.call("Get", {
          typeName: "LogRecord",
          search: {
            deviceSearch: { id: deviceId },
            fromDate: fromDate,
            toDate: toDate
          }
        }, function(logs) {
          var coords = [];
          for (var i = 0; i < logs.length; i++) {
            var l = logs[i];
            if (l.latitude && l.longitude) {
              coords.push([l.longitude, l.latitude]);
            }
          }
          log("ðŸ“ Registros obtenidos: " + coords.length);
          callback(coords);
        }, function(err) {
          log("âŒ Error al obtener logs: " + err);
          callback([]);
        });
      }

      function createKML(coords, name) {
        if (coords.length < 2) {
          log("âš ï¸ No hay suficientes puntos para generar lÃ­nea.");
          return;
        }

        try {
          var line = turf.lineString(coords);
          var buffer = turf.buffer(line, 10, { units: 'meters' });
          buffer.properties = { name: name || "KML" };
          var kml = tokml(buffer);
          var blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
          var a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = (name || "Traza") + ".kml";
          a.click();
          log("âœ… Archivo KML generado.");
        } catch (e) {
          log("âŒ Error al generar KML: " + e);
        }
      }

      document.getElementById("generate").addEventListener("click", function() {
        var deviceId = document.getElementById("deviceSelect").value;
        var from = new Date(document.getElementById("fromDate").value).toISOString();
        var to = new Date(document.getElementById("toDate").value).toISOString();
        var filename = document.getElementById("filename").value;

        if (!deviceId) {
          log("âš ï¸ SeleccionÃ¡ un dispositivo.");
          return;
        }

        getLogRecords(deviceId, from, to, function(coords) {
          createKML(coords, filename);
        });
      });

      geotab.addin.exportKML = function(api_, state_) {
        api = api_;
        state = state_;

        return {
          initialize: function(api, state, callback) {
            log("ðŸš€ Add-in inicializado");
            loadDevices();
            callback();
          },
          focus: function(api, state){},
          blur: function() {}
        };
      };
    })();
  </script>
</body>
</html>

