<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Documentación Conductores</title>
<style>
body { font-family: Arial; margin: 0; padding: 0; }
.container { display: flex; height: 100vh; }
.left, .right { flex: 1; padding: 15px; overflow-y: auto; }
.left { border-right: 1px solid #ccc; }
table { width: 100%; border-collapse: collapse; }
th, td { border: 1px solid #ccc; padding: 6px; }
#log { height: 120px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #ccc; padding: 5px; margin-top: 10px; }
</style>
</head>
<body>
<div class="container">
<div class="left">
<h2>Documentación por vencer</h2>
<table id="docTable">
<thead><tr><th>Conductor</th><th>Documento</th><th>Vence</th></tr></thead>
<tbody></tbody>
</table>
<div id="log"></div>
</div>
<div class="right">
<h2>Asignar documento</h2>
<label>Conductor</label><br>
<select id="userSelect"></select><br><br>
<label>Documento</label><br>
<input id="docName" type="text"><br><br>
<label>Vencimiento</label><br>
<input id="expiryDate" type="date"><br><br>
<button id="saveBtn">Guardar</button>
<hr>
<h3>Carga masiva</h3>
<input id="excelFile" type="file" accept=".xlsx,.xls" style="display:none">
<button id="uploadBtn">Subir Excel</button>
</div>
</div>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
(function(){
var api=null; var state=null; var logBox=null; var addInId=null;
function log(t){ logBox.textContent+=t+"\n"; logBox.scrollTop=logBox.scrollHeight; }
function loadUsers(){ log("Cargando usuarios..."); api.call("Get",{typeName:"User"},function(r){ var s=document.getElementById("userSelect"); s.innerHTML=""; r.forEach(function(u){ var o=document.createElement("option"); o.value=u.id; o.textContent=u.name||u.id; s.appendChild(o); }); log("Usuarios cargados: "+r.length); },function(e){ log("Error usuarios: "+e); }); }
function loadDocuments(){ log("Cargando documentos..."); api.call("Get",{typeName:"AddInData",search:{addInId:addInId}},function(r){ var tb=document.querySelector("#docTable tbody"); tb.innerHTML=""; r.forEach(function(it){ var d=it.details||{}; var uid=d.userId; var docs=d.documents||[]; docs.forEach(function(dc){ var tr=document.createElement("tr"); var td1=document.createElement("td"); var td2=document.createElement("td"); var td3=document.createElement("td"); td1.textContent=uid; td2.textContent=dc.type; td3.textContent=dc.expiryDate; tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tb.appendChild(tr); }); }); log("Documentos cargados"); },function(e){ log("Error doc: "+e); }); }
function saveDocument(){ var uid=document.getElementById("userSelect").value; var dn=document.getElementById("docName").value; var ex=document.getElementById("expiryDate").value; var data={userId:uid,documents:[{type:dn,expiryDate:ex}]}; api.call("Add",{typeName:"AddInData",entity:{addInId:addInId,details:data}},function(){ log("Guardado"); loadDocuments(); },function(e){ log("Error guardado: "+e); }); }
function uploadExcel(e){ var f=e.target.files[0]; if(!f)return; var fr=new FileReader(); fr.onload=function(){ var wb=XLSX.read(fr.result,{type:"binary"}); var ws=wb.Sheets[wb.SheetNames[0]]; var j=XLSX.utils.sheet_to_json(ws,{header:1}); var p=Promise.resolve(); for(var i=1;i<j.length;i++){ (function(row){ var uid=row[0]; var dn=row[1]; var ex=row[2]; if(!uid||!dn||!ex)return; var data={userId:uid,documents:[{type:dn,expiryDate:ex}]}; p=p.then(function(){ return new Promise(function(res){ api.call("Add",{typeName:"AddInData",entity:{addInId:addInId,details:data}},function(){res();},function(){res();}); }); }); })(j[i]); }
 p.then(function(){ log("Excel procesado"); loadDocuments(); }); };
 fr.readAsBinaryString(f);
}
window.geotab.addin.docVencimientos=function(elt,_api,_state){ api=_api; state=_state; addInId=_state.addInId; logBox=document.getElementById("log"); loadUsers(); loadDocuments(); document.getElementById("saveBtn").onclick=saveDocument; document.getElementById("uploadBtn").onclick=function(){ document.getElementById("excelFile").click(); }; document.getElementById("excelFile").onchange=uploadExcel; };
})();
</script>
</body>
</html>
