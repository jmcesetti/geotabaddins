<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Documentos</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
        }
        .inputBox {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 4px;
        }
        input[type=text], input[type=date] {
            width: 250px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        button {
            padding: 10px 16px;
            background: #0084ff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        #msg {
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h2>Documentos del Usuario</h2>

    <div class="inputBox">
        <label>Documento</label>
        <input id="docName" type="text">
    </div>

    <div class="inputBox">
        <label>Vencimiento</label>
        <input id="docDate" type="date">
    </div>

    <button id="btnSave">Guardar</button>

    <div id="msg"></div>

    <script>
        var api;
        var currentUserId;

        function loadExisting(addInId, callback) {
            api.call("Get", {
                typeName: "AddInData",
                search: { addInId: addInId }
            }, function(result) {
                if (result && result.length > 0) {
                    callback(result[0]);
                } else {
                    callback(null);
                }
            }, function() {
                callback(null);
            });
        }

        function saveDocument() {
            var name = document.getElementById("docName").value;
            var vence = document.getElementById("docDate").value;
            if (!name || ! vence) {
                document.getElementById("msg").innerText = "Falta completar datos";
                return;
            }

            var addInId = "DOC_" + currentUserId;
            loadExisting(addInId, function(existing) {
                if (existing) {
                    if (!existing.details) existing.details = {};
                    if (!existing.details.documents) existing.details.documents = [];
                    existing.details.documents.push({
                        nombre: name,
                        vence: vence
                    });
                    api.call("Set", {
                        typeName: "AddInData",
                        entity: existing
                    }, function() {
                        document.getElementById("msg").innerText = "Actualizado";
                    }, function(e) {
                        document.getElementById("msg").innerText = "Error: " + JSON.stringify(e);
                    });
                } else {
                    var entity = {
                        addInId: addInId,
                        details: {
                            userId: currentUserId,
                            documents: [
                                {
                                    nombre: name,
                                    vence: vence
                                }
                            ]
                        }
                    };
                    api.call("Add", {
                        typeName: "AddInData",
                        entity: entity
                    }, function() {
                        document.getElementById("msg").innerText = "Guardado";
                    }, function(e) {
                        document.getElementById("msg").innerText = "Error: " + JSON.stringify(e);
                    });
                }
            });
        }

        document.getElementById("btnSave").addEventListener("click", saveDocument);

        geotab.addin.documentos = function(apiRef, state) {
            api = apiRef;
            api.getSession(function(s) {
                currentUserId = s.userName;
            });
            return {
                initialize: function(apiRef, state) {},
                draw: function(apiRef, state) {}
            };
        };
    </script>
</body>
</html>
